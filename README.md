# Microsoft Verified Terraform Module

The Verified Terraform module is a template repository to help developers create their own Terraform Module.

As we've used Microsoft 1ES Runners Pool as our acceptance test runner, **only Microsoft members could use this template for now**.

Enjoy it by following steps:

1. Use [this template](https://github.com/Azure/terraform-verified-module) to create your repository.
2. Read [Onboard 1ES hosted Github Runners Pool through Azure Portal](https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-docs/1es-github-runners/createpoolportal), install [1ES Resource Management](https://github.com/apps/1es-resource-management) on your repo.
3. Add a Github [Environment](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment) named **acctests** in your repo, setup [**Required Reviewers**](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment#required-reviewers).
4. Update [`acc-test.yaml`](.github/workflows/acc-test.yaml), modify `runs-on: [self-hosted, 1ES.Pool=<YOUR_REPO_NAME>]` with your 1es runners' pool name (basically it's your repo's name).
5. Write Terraform code in a new branch.
6. Run `docker run --rm -v ${pwd}:/src -w /src mcr.microsoft.com/azterraform:latest make pre-commit` to format the code.
7. Run `docker run --rm -v $(pwd):/src -w /src mcr.microsoft.com/azterraform:latest make pr-check` to run the check in local.
8. Create a pull request for the main branch.
    * CI pr-check will be executed automatically.
    * Once pr-check was passed, with manually approval, the e2e test and version upgrade test would be executed.
9. Merge pull request.
10. Enjoy it!

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name                                                                      | Version       |
|---------------------------------------------------------------------------|---------------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3        |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm)       | >= 3.1, < 4.0 |

## Providers

| Name                                                                | Version       |
|---------------------------------------------------------------------|---------------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm)       | >= 3.1, < 4.0 |
| <a name="provider_cloudinit"></a> [cloudinit](#provider\_cloudinit) | n/a           |

## Modules

No modules.

## Resources

| Name                                                                                                                                       | Type        |
|--------------------------------------------------------------------------------------------------------------------------------------------|-------------|
| [azurerm_linux_virtual_machine.csr](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/linux_virtual_machine) | resource    |
| [azurerm_network_interface.csr](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface)         | resource    |
| [azurerm_public_ip.csr](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip)                         | resource    |
| [azurerm_subnet.csr](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet)                               | resource    |
| [cloudinit_config.config](https://registry.terraform.io/providers/hashicorp/cloudinit/latest/docs/data-sources/config)                     | data source |

## Inputs

| Name                                                                                               | Description                                                   | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Default  | Required |
|----------------------------------------------------------------------------------------------------|---------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|:--------:|
| <a name="input_admin_password"></a> [admin\_password](#input\_admin\_password)                     | The admin password for the virtual machine.                   | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a      |   yes    |
| <a name="input_admin_username"></a> [admin\_username](#input\_admin\_username)                     | The admin username for the virtual machine.                   | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a      |   yes    |
| <a name="input_custom_data"></a> [custom\_data](#input\_custom\_data)                              | The custom data to use for the virtual machine.               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a      |   yes    |
| <a name="input_identity"></a> [identity](#input\_identity)                                         | values for the identity to use for the virtual machine.       | <pre>object({<br>    type         = string<br>    identity_ids = optional(list(string))<br>  })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `null`   |    no    |
| <a name="input_image"></a> [image](#input\_image)                                                  | values for the image to use for the virtual machine.          | <pre>object({<br>    plan_id      = string<br>    publisher_id = string<br>    product_id   = string<br>    version      = optional(string, "latest")<br>  })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a      |   yes    |
| <a name="input_location"></a> [location](#input\_location)                                         | The location/region of the resources.                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a      |   yes    |
| <a name="input_network_interfaces"></a> [network\_interfaces](#input\_network\_interfaces)         | A map of network\_interfaces to create.                       | <pre>map(object({<br>    accelerated_networking_enabled = optional(bool)<br>    name                           = optional(string)<br>    primary_interface              = optional(string, false)<br>    private_ip_address             = optional(string)<br>    private_ip_address_allocation  = optional(string, "Dynamic")<br>    public_ip_creation_enabled     = optional(bool, false)<br>    public_ip_config = optional(object({<br>      name              = optional(string)<br>      allocation_method = optional(string, "Dynamic")<br>      sku               = optional(string)<br>      tags              = optional(map(string), {})<br>    }), {})<br>    subnet_config = object({<br>      name             = optional(string)<br>      address_prefixes = list(string)<br>      tags             = optional(map(string))<br>    })<br>  }))</pre> | `{}`     |    no    |
| <a name="input_os_disk"></a> [os\_disk](#input\_os\_disk)                                          | The os disk configuration to use for the virtual machine.     | <pre>object({<br>    caching              = optional(string, "ReadOnly")<br>    storage_account_type = optional(string, "Standard_LRS")<br>    name                 = optional(string, null)<br>  })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `{}`     |    no    |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name)    | The name of the resource group.                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a      |   yes    |
| <a name="input_tracing_tags_enabled"></a> [tracing\_tags\_enabled](#input\_tracing\_tags\_enabled) | Whether enable tracing tags that generated by BridgeCrew Yor. | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `false`  |    no    |
| <a name="input_tracing_tags_prefix"></a> [tracing\_tags\_prefix](#input\_tracing\_tags\_prefix)    | Default prefix for generated tracing tags                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `"avm_"` |    no    |
| <a name="input_virtual_machine_name"></a> [virtual\_machine\_name](#input\_virtual\_machine\_name) | The name of the virtual machine.                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a      |   yes    |
| <a name="input_virtual_network_name"></a> [virtual\_network\_name](#input\_virtual\_network\_name) | The name of the virtual network.                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a      |   yes    |
| <a name="input_vm_size"></a> [vm\_size](#input\_vm\_size)                                          | The size of the virtual machine.                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a      |   yes    |

## Outputs

| Name                                                                                         | Description                                                                     |
|----------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------|
| <a name="output_network_interfaces"></a> [network\_interfaces](#output\_network\_interfaces) | value is a map of objects with the following attributes: id, name, private\_ip  |
| <a name="output_public_ips"></a> [public\_ips](#output\_public\_ips)                         | value is a map of objects with the following attributes: id, name, ip\_address  |
| <a name="output_virtual_machine"></a> [virtual\_machine](#output\_virtual\_machine)          | value is a map of objects with the following attributes: id, name, identity\_id |
<!-- END_TF_DOCS -->
